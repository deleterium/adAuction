<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Auction helper page - TESTNET</title>
    <script src="https://cdn.jsdelivr.net/npm/@signumjs/core/dist/signumjs.min.js" type="text/javascript"></script>
    <script src='https://cdn.jsdelivr.net/npm/@signumjs/wallets/dist/signumjs.wallets.min.js' type="text/javascript"></script>

<script type="text/javascript">
    const Config = {
        smartContractId: "12532148064615401236",
        timerContractId: "13130160368463026721",
        appName: "Ad Auction",
        networkName: "Signum-TESTNET",
        defaultServer: "https://europe3.testnet.signum.network"
    }

    const Global = {
        server: undefined,
        wallet: undefined,
        walletResponse: undefined,
        signumJSAPI: undefined,
        nextAuction: 0,
        mapProps: []
    }

    function updateDefaultNode(selectedNode) {
        Global.server = selectedNode
        Global.signumJSAPI = sig$.composeApi({
            nodeHost: Global.server
        });
    }

    function UnlinkAccount() {
        Global.walletSubscription?.unlisten();
        Global.wallet = undefined;
        Global.walletResponse = undefined;
        document.getElementById('rs_account').innerText = "None"
    }

    function updateLinkedAccount() {
        document.getElementById('rs_account').innerText = idTOaccount(Global.walletResponse.accountId)
    }

    function errorCallback(message) {
        document.getElementById('output').innerHTML = message.replace(/\n/g, "<br />");
        alert('Oh no... An error has occurred.')
    }
    function successCallback(message) {
        document.getElementById('output').innerHTML = message.replace(/\n/g, "<br />");
        alert('Success!!! Wait 8 minutes and check your account.')
    }

    async function linkXT() {
        if (Global.wallet === undefined) {
            Global.wallet = new sig$wallets.GenericExtensionWallet();
            try {
                Global.walletResponse = await Global.wallet.connect({
                    appName: Config.appName ,
                    networkName: Config.networkName
                })
                updateDefaultNode(Global.walletResponse.currentNodeHost)
                Global.walletSubscription = Global.walletResponse.listen({
                    onAccountChanged: (newVal) => {
                        Global.walletResponse.publicKey = newVal.accountPublicKey;
                        Global.walletResponse.accountId = newVal.accountId;
                        updateLinkedAccount();
                    },
                    onNetworkChanged: (newNetwork) => {
                        if (newNetwork.networkName !== Config.networkName) {
                            evtUnlinkAccount();
                            return;
                        }
                        updateDefaultNode(newNetwork.networkHost)
                    }
                })
                updateLinkedAccount();
            } catch (err) {
                UnlinkAccount()
                errorCallback("Signum XT Wallet error:\n\n" + err.message)
            }
        }
    }

    async function onwerSend() {
        if (Global.walletResponse === null || Global.walletResponse === undefined) {
            UnlinkAccount()
            errorCallback("Signum XT wallet extension not activated. To use this feature you need to install the extension and link your account at main page.")
            return
        }
        const strBalance = document.getElementById("cmdAmount").value
        let numberBalance = Number(strBalance)
        if (isNaN(numberBalance)) {
            numberBalance = Number(strBalance.replace(',','.'))
        }
        if (isNaN(numberBalance)) {
            numberBalance = "0"
        }
        const strCommand = document.getElementById("cmdCommand").value.trim()
        if (!confirm(`You will send command '${strCommand}' and ${numberBalance} Signa to the contract ${idTOaccount(Config.smartContractId)}. You must be the owner.`)) {
            return
        }

        const parameters = {
            amountNQT: (BigInt(numberBalance * 1e8) + 50000000n).toString(),
            publicKey: Global.walletResponse.publicKey,
            recipient: Config.smartContractId,
            message: strCommand,
            messageIsText: "true",
            feeNQT: "2000000",
            deadline: "8",
        }
        try {
            const Response = await Global.signumJSAPI.service.send('sendMoney', parameters)
            const retObj = await Global.wallet.confirm(Response.unsignedTransactionBytes)
            console.log(retObj)
            successCallback(`Transaction broadcasted! Id: ${retObj.transactionId}`)
        } catch(err) {
            errorCallback(`Transaction failed.\n\n${err.message}`)
        }
    }

    
    //Input id in unsigned long (BigInt)
    //Output string with account address (Reed-Salomon encoded)
    function idTOaccount(id) {
        let gexp = [1, 2, 4, 8, 16, 5, 10, 20, 13, 26, 17, 7, 14, 28, 29, 31, 27, 19, 3, 6, 12, 24, 21, 15, 30, 25, 23, 11, 22, 9, 18, 1]
        let glog = [0, 0, 1, 18, 2, 5, 19, 11, 3, 29, 6, 27, 20, 8, 12, 23, 4, 10, 30, 17, 7, 22, 28, 26, 21, 25, 9, 16, 13, 14, 24, 15]
        let cwmap = [3, 2, 1, 0, 7, 6, 5, 4, 13, 14, 15, 16, 12, 8, 9, 10, 11]
        let alphabet = "23456789ABCDEFGHJKLMNPQRSTUVWXYZ".split("")
        let base32alpha="0123456789abcdefghijklmnopqrstuv"
        let base32Length = 13
        let account = "TS-"
        let i;
        function gmult(a, b) {
            if (a == 0 || b == 0) {
                return 0;
            }
            return gexp[ (glog[a] + glog[b]) % 31 ]
        }
        const base32=BigInt(id).toString(32).padStart(13,"0").split("")
        var codeword=[]
        for (i=0; i<base32Length; i++){
            codeword.push( base32alpha.indexOf(base32[12-i]) );
        }
        var p = [0, 0, 0, 0]
        for (i=base32Length-1; i>=0; i--) {
            let fb = codeword[i] ^ p[3]
            p[3] = p[2] ^ gmult(30, fb)
            p[2] = p[1] ^ gmult(6, fb)
            p[1] = p[0] ^ gmult(9, fb)
            p[0] = gmult(17, fb)
        }
        codeword.push(p[0], p[1], p[2], p[3])
        for (i=0; i<17; i++) {
            account+=alphabet[codeword[cwmap[i]]]
            if ((i & 3) == 3 && i < 13) {
                account+="-"
            }
        }
        return account
    }

    window.onload = async function (){
        await requestContractData();

        document.getElementById('contract').innerHTML =
            "Ad Auction address: " + idTOaccount(Config.smartContractId) + "<br>\n" +
            "Timer contract address: " + idTOaccount(Config.timerContractId) + "<br>\n" +
            "Next auction: " + (Global.nextAuction + 1) + "<br>\n" +
            "Default ad transaction: " + Global.mapProps[0][0] + "<br>\n" +
            "Current ad transaction: " + Global.mapProps[0][1] + "<br>\n" +
            "Contract state: " + (Global.mapProps[0][2] === "1" ? "suspended" : "running") + "<br>\n" +
            "Minimum bid amount: " +  Global.mapProps[1][0] + "<br>\n" +
            "Minimum increment amount: " +  Global.mapProps[1][1] + "<br>\n" +
            "Current highest address: " + idTOaccount(Global.mapProps[1][2]) + "<br>\n" +
            "Current highest amount: " +  Global.mapProps[1][3] + "<br>\n" +
            "Current highest TransactionID AD: " +  Global.mapProps[1][4] + "<br>\n"
    }

    async function requestContractData() {
        let response, contractInfo, mapInfo

        try {
            response = await fetch(`${Config.defaultServer}/api?requestType=getATDetails&at=${Config.timerContractId}`)
        } catch (error) {
            console.log(error.message)
            return;
        }
        contractInfo = await response.json();
        if (contractInfo.nextBlock === undefined) {
            return;
        }
        Global.nextAuction = parseInt(contractInfo.nextBlock)

        try {
            response = await fetch(`${Config.defaultServer}/api?requestType=getATMapValues&at=${Config.smartContractId}&key1=0`)
        } catch (error) {
            console.log(error.message)
            return;
        }
        mapInfo = await response.json();
        if (mapInfo.keyValues === undefined) {
            return;
        }
        Global.mapProps[0] = [
            mapInfo.keyValues.find((item) => item.key2 == "0")?.value ?? "0",
            mapInfo.keyValues.find((item) => item.key2 == "1")?.value ?? "0",
            mapInfo.keyValues.find((item) => item.key2 == "2")?.value ?? "0"
        ]

        try {
            response = await fetch(`${Config.defaultServer}/api?requestType=getATMapValues&at=${Config.smartContractId}&key1=1`)
        } catch (error) {
            console.log(error.message)
            return;
        }
        mapInfo = await response.json();
        if (mapInfo.keyValues === undefined) {
            return;
        }
        Global.mapProps[1] = [
            parseInt(mapInfo.keyValues.find((item) => item.key2 == "0")?.value ?? 0)/1e8,
            parseInt(mapInfo.keyValues.find((item) => item.key2 == "1")?.value ?? 0)/1e8,
            mapInfo.keyValues.find((item) => item.key2 == "2")?.value ?? "0",
            parseInt(mapInfo.keyValues.find((item) => item.key2 == "3")?.value ?? 0)/1e8,
            parseInt(mapInfo.keyValues.find((item) => item.key2 == "4")?.value ?? 0)/1e8
        ]
    }
</script>

</head>
<body>
  <div>
    <h1>Ad Auction helper page for TESTNET</h1>
    <h3>XT wallet info</h3>
    <button onclick="linkXT()">Link</button><br>
    Linked account: <output id="rs_account">None</output>
    <h3>Onwer section</h3>
    Command: <input type="text" id="cmdCommand"><br>
    Amount: <input type="number" id="cmdAmount"><br>
    <button onclick="onwerSend()">Send</button>
    <h3>User section</h3>
    <button onclick="loadTMG()">Load TMG</button><br>
    <button onclick="changeLimit()">Change limit</button><br>
    <button onclick="play()">Play</button><br>
    <h3>Contract details</h3>
    <div id="contract"></div>
    <h3>Status</h3>
    <div id="output"></div>
  </div>
</body>
</html>
